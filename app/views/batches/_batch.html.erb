<div id="batch_<%= batch.id %>" class="bg-white p-4 shadow rounded-lg mb-4">
  <div class="flex justify-between items-start">
    <h2 class="text-lg font-semibold text-gray-800"><%= batch.batch_number %></h2>
    <% if batch.notification_days_before_expiration.present? %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
        <svg class="-ml-0.5 mr-1.5 h-3 w-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <% if batch.expiration_date && (days_remaining = (batch.expiration_date - Date.today).to_i) <= batch.notification_days_before_expiration %>
          <%= t('batches.expires_in', count: days_remaining) %>
        <% else %>
          <%= t('batches.alerts_before_expiry', count: batch.notification_days_before_expiration) %>
        <% end %>
      </span>
    <% end %>
  </div>

  <div class="mt-2 space-y-1">
    <p class="text-gray-600 text-sm"><strong><%= t('batches.manufactured_date') %>:</strong> <%= batch.manufactured_date || t('batches.na') %></p>
    <p class="text-gray-600 text-sm"><strong><%= t('batches.expiration_date') %>:</strong> <%= batch.expiration_date || t('batches.na') %></p>
  </div>

  <div class="mt-4">
    <% products = batch.products.where(account_id: Current.account.id).distinct %>

    <strong class="text-gray-700 text-sm"><%= t('batches.products_with_count', count: products.size) %>:</strong>
    <% products.each do |product| %>
      <div class="mt-2 pl-2 border-l-2 border-gray-200">
        <p class="text-gray-700 font-semibold text-sm"><%= product.name %></p>
    
        <% inventory_items = product.inventory_items.includes(:location).where(batch_id: batch.id) %>
        <% grouped_by_location = inventory_items.group_by { |item| item.location } %>
        
        <ul class="ml-4 text-gray-600 text-xs">
          <% grouped_by_location.each do |location, items| %>
            <li class="mt-1">
              <strong><%= location&.name || t('batches.no_location') %>:</strong> 
              <% items.group_by(&:unit_type).each do |unit_type, unit_items| %>
                <%= unit_items.sum(&:quantity) %> <%= unit_type.pluralize(unit_items.sum(&:quantity)) %>
                <% unless unit_type == items.last.unit_type %> | <% end %>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>

  <div class="mt-4 space-x-2">
    <%= link_to t('actions.show'), batch_path(batch), data: { turbo_frame: 'main' }, class: "text-blue-500 hover:underline text-xs" %>
    <%= link_to t('actions.edit'), edit_batch_path(batch), data: { turbo_frame: 'main' }, class: "text-yellow-500 hover:underline text-xs" %>
    <%= link_to t('actions.delete'), batch, data: { turbo_method: :delete, turbo_frame: "batch_#{batch.id}", turbo_confirm: t('confirmations.delete_batch') }, class: "text-red-500 hover:underline text-xs" %>
  </div>
</div>
