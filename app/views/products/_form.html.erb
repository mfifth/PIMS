<turbo-frame id='main'>
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md" data-controller="product-form" data-product-form-product-id-value="<%= @product.id %>">
    <h1 class="text-3xl font-semibold text-center text-gray-800 mb-6">
      <%= @product.new_record? ? t('products.create_new') : t('products.edit') %>
    </h1>

    <% if @product.errors.any? %>
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded">
        <ul class="list-disc pl-5 mt-2 text-red-700">
          <% @product.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with(model: @product, local: true, class: "space-y-6") do |form| %>

      <!-- General Product Information -->
      <div class="border-b pb-4">
        <h2 class="text-lg font-medium text-gray-700 mb-2"><%= t('products.general_info') %></h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= form.label :name, t('products.product_name'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field :name, required: true, class: "w-full px-4 py-2 border rounded-lg" %>
          </div>

          <div>
            <%= form.label :sku, t('products.sku'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field :sku, required: true, class: "w-full px-4 py-2 border rounded-lg" %>
          </div>

          <div>
            <%= form.label :category_id, t('products.select_existing_category'), class: "block text-sm font-medium text-gray-700" %>
            <%= turbo_frame_tag "category_select_#{form.object.id}" do %>
              <%= render 'products/category_select', product: @product %>
            <% end %>
          </div>

          <% if @product.category.present? %>
            <div class="mt-2 flex justify-center items-center">
              <%= turbo_frame_tag "category-remove" do %>
                <%= link_to t('products.remove_category'), remove_category_product_path(@product), data: { turbo_method: :delete, turbo_frame: "category_select_#{form.object.id}", turbo_confirm: t('products.confirm_remove_category') }, class: "text-red-500 text-md mx-[10px] my-0", style: "margin: 0px 10px;" %>
                <%= link_to t('products.delete_category'), delete_category_product_path(@product), data: { turbo_method: :delete, turbo_confirm: t('products.confirm_delete_category_from_all') }, class: "text-red-500 text-md mx-[10px] my-0", style: "margin: 0px 10px;" %>
              <% end %>
            </div>
          <% end %>

          <div>
            <%= form.label :category_name, t('products.create_new_category'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field :category_name, class: "w-full px-4 py-2 border rounded-lg" %>
          </div>
        </div>

        <div class="mt-4">
          <%= form.label :description, t('products.description'), class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :description, rows: 3, class: "w-full px-4 py-2 border rounded-lg" %>
        </div>

        <div class="mt-4 flex items-center">
          <%= form.check_box :perishable, class: "h-5 w-5 text-green-600", id: "perishable_checkbox", data: { action: "change->product-form#updateFieldsVisibility" } %>
          <%= form.label :perishable, t('products.is_perishable'), class: "ml-2 text-sm font-medium text-gray-700" %>
        </div>
      </div>

      <!-- Current Batches Section -->
      <% if @product.batches.any? %>
        <div class="border-b pb-4">
          <h2 class="text-lg font-medium text-gray-700 mb-2"><%= t('products.current_batches') %></h2>
          
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t('products.batch_number') %></th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t('products.manufactured_date') %></th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t('products.expiration_date') %></th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t('products.location') %></th>
                  <th class="px-6 py-3"></th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @product.batches.each do |batch| %>
                  <% inventory_item = @product.inventory_items.find_by(batch_id: batch.id) %>
                  <tr id="batch_<%= batch.id %>">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= batch.batch_number %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= batch.manufactured_date %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= batch.expiration_date %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <%= inventory_item&.location&.name || 'N/A' %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <%= link_to t('products.remove'), remove_batch_product_path(@product, batch_id: batch.id), 
                          data: { turbo_method: :delete, turbo_confirm: t('products.confirm_remove_batch') },
                          class: "text-red-500 hover:text-red-700" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <!-- Batch Information -->
      <div id="batch_fields" class="border-b pb-4" data-product-form-target="batchFields" style="<%= @product.perishable? ? '' : 'display: none;' %>">
        <h2 class="text-lg font-medium text-gray-700 mb-2"><%= @product.batches.any? ? t('products.add_another_batch') : t('products.batch_info') %></h2>

        <div>
          <%= form.label :selected_batch_id, t('products.select_existing_batch'), class: "block text-sm font-medium text-gray-700" %>
          <%= form.collection_select :selected_batch_id, 
                Current.account.batches,
                :id, :batch_info, 
                { include_blank: t('products.create_new_batch') }, 
                { class: "w-full px-4 py-2 border rounded-lg", 
                  data: { 
                    product_form_target: "batchSelect",
                    action: "change->product-form#updateNewBatchFields"
                  } } %>
        </div>

        <div id="new_batch_fields" data-product-form-target="newBatchFields" style="<%= @product.batches.any? && params[:selected_batch_id].blank? ? 'display: none;' : '' %>">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <%= form.label :batch_number, t('products.batch_number'), id: 'batch-number', class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field :batch_number, class: "w-full px-4 py-2 border rounded-lg" %>
            </div>

            <div>
              <%= form.label :manufactured_date, t('products.manufactured_date'), class: "block text-sm font-medium text-gray-700" %>
              <%= form.date_field :manufactured_date, class: "w-full px-4 py-2 border rounded-lg" %>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <%= form.label :expiration_date, t('products.expiration_date'), class: "block text-sm font-medium text-gray-700" %>
              <%= form.date_field :expiration_date, min: Date.today.to_s, id: 'product_expiration_date', class: "w-full px-4 py-2 border rounded-lg" %>
            </div>

            <div>
              <%= form.label :notification_days_before_expiration, t('products.notify_before_expiry'), class: "block text-sm font-medium text-gray-700" %>
              <%= form.number_field :notification_days_before_expiration, min: 0, step: 1,
                value: @product.batches.last&.notification_days_before_expiration || 0,
                class: "w-full px-4 py-2 border rounded-lg" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory & Price Per Unit Section -->
      <div class="border-b pb-4">
        <h2 class="text-lg font-medium text-gray-700 mb-4"><%= t('products.inventory_info') %></h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= form.label :location_id, t('products.location'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :location_id, 
                  Location.where(account_id: Current.account.id).pluck(:name, :id),
                  { include_blank: t('products.select_location') }, 
                  { class: "w-full px-3 py-2 border rounded-md",
                    data: { 
                      product_form_target: "locationSelect",
                      action: "change->product-form#fetchInventory"
                    } } %>
          </div>

          <div>
            <%= form.label :quantity, t('products.quantity'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :quantity, required: true, step: 1, min: 0, class: "w-full px-3 py-2 border rounded-md", data: { product_form_target: "quantity" } %>
          </div>

          <div>
            <%= form.label :price, t('products.price_per_unit'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :price, step: 0.01, min: 0, class: "w-full px-3 py-2 border rounded-md", data: { product_form_target: "price" } %>
          </div>

          <div>
            <%= form.label :low_threshold, t('products.low_stock_alert'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :low_threshold, class: "w-full px-3 py-2 border rounded-md", data: { product_form_target: "lowThreshold" } %>
          </div>

          <div>
            <%= form.label :unit_type, t('products.unit_type_title'), class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :unit_type, 
                Product::VALID_UNITS.map { |u| [I18n.t("units.#{u}"), u] },
                { selected: @product.unit_type.presence || 'units'},
                { class: "w-full px-4 py-2 border rounded-lg",
                  data: { product_form_target: "unitType" },
                  required: true,
                  prompt: false } %>

          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-between mt-6">
        <%= form.submit @product.new_record? ? t('products.create') : t('products.update'),
            class: "bg-blue w-1/2 py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500" %>
        <%= link_to t('products.cancel'), products_path, class: "bg-gray text-white hover:text-gray-700 rounded-lg px-6 py-3 transition" %>
      </div>
    <% end %>
  </div>
</turbo-frame>