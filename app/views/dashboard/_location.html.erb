<li class="bg-gray-50 p-4 rounded-md shadow-sm hover:shadow-md transition flex flex-col">
  <div class="flex justify-between items-center">
    <a href="<%= location_path(location) %>" class="text-green-600 font-medium">
      <%= location.name %>
    </a>

    <% if location.location_uid %>
      <span class="badge-success"><%= t("locations.synced") %></span>
    <% end %>
  </div>

  <div class="mt-2 text-sm text-gray-700">
    <% all_items = location.inventory_items.includes(:product) %>
    <% perishable_count = all_items.sum { |item| item.product.perishable ? item.quantity : 0 } %>
    <% non_perishable_count = all_items.sum { |item| item.product.perishable ? 0 : item.quantity } %>
    <% total_value = all_items.sum { |item| item.quantity * (item.product.price || 0) } %>

    <p class="text-md text-gray-500">
      <%= t("locations.items_count", count: perishable_count + non_perishable_count) %>
    </p>
    <p class="text-md text-gray-500">
      <%= t("locations.total_value", value: number_with_precision(total_value, precision: 2)) %>
    </p>

    <!-- Expiring Items Section -->
    <% expiring_items = location.inventory_items.joins(product: :batch)
                               .where("batches.expiration_date BETWEEN ? AND ?", 
                                      Date.current, 
                                      1.week.from_now.to_date)
                               .order("batches.expiration_date ASC") %>
    <% if expiring_items.any? %>
      <div class="mt-3 space-y-1.5">
        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">
          <%= t("locations.expiring_soon") %>
        </h4>
        <ul class="space-y-1">
          <% expiring_items.each do |item| %>
            <li class="flex justify-between items-center text-xs py-0.5">
              <span class="truncate pr-1"><%= item.product.name %></span>
              <span class="text-red-600 whitespace-nowrap bg-red-50 px-1.5 py-0.5 rounded-full">
                <%= item.product.batch.expiration_date.strftime("%b %d") %>
              </span>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Low Stock Section -->
    <% low_items = @low_stock_items[location.id] || [] %>
    <% if low_items.any? %>
      <div class="mt-3 border-l-4 border-red-400 bg-red-50/50 rounded-r-lg p-3">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
            </svg>
          </div>
          <div class="ml-3 flex-1">
            <h3 class="text-sm font-medium text-red-800">
              <%= t("locations.low_stock_alert", count: low_items.count) %>
            </h3>
            <div class="mt-2">
              <ul class="space-y-2">
                <% low_items.each do |item| %>
                  <li class="flex justify-between text-sm">
                    <span class="font-medium text-red-700 truncate max-w-[160px]">
                      <%= item.product.name %>
                    </span>
                    <span class="ml-2 whitespace-nowrap text-red-600">
                      <%= item.quantity %> <%= t('locations.left') %>
                    </span>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <% 
      @available_recipes = @recipes.select do |recipe|
        quantity, = max_quantity_and_expiration(location, recipe)
        quantity.positive?
      end
    %>

    <!-- Recipes You Can Make -->
    <% if @available_recipes.present? %>
      <div class="mt-3 bg-green-50 rounded-md p-3 space-y-2 border border-green-100">
        <div class="flex items-center">
          <svg class="h-5 w-5 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <h3 class="ml-2 text-sm font-medium text-green-800">
            <%= t("recipes.available_recipes") %>
          </h3>
        </div>

        <ul class="space-y-2">
          <% @available_recipes.each do |recipe| %>
            <% quantity, expiration = max_quantity_and_expiration(location, recipe) %>
            <% next if quantity.zero? %>
            <li class="text-sm">
              <div class="flex justify-between items-baseline">
                <span class="font-medium text-gray-700"><%= recipe.name %></span>
                <span class="text-green-600 text-xs font-medium ml-2">
                  <%= quantity %> <%= t("recipes.can_make") %>
                </span>
              </div>
              <% if expiration %>
                <p class="text-xs text-green-700 mt-0.5">
                  <%= t("recipes.until") %> <%= l(expiration) %>
                </p>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <p class="text-xs text-gray-400 mt-2">
      <%= t("locations.updated", time: time_ago_in_words(location.updated_at)) %>
    </p>
  </div>
</li>
