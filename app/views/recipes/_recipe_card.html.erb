<div
  data-controller="recipe-card"
  data-recipe-card-i18n-missing-inventory-value="<%= t('recipes.margin_calculator.missing_inventory', product: '%{product}') %>"
  data-recipe-card-i18n-invalid-price-value="<%= t('recipes.margin_calculator.invalid_price') %>"
  data-recipe-card-i18n-from-location-price-value="<%= t('recipes.margin_calculator.from_location_price', location: '%{location}', price: '%{price}', unit: '%{unit}') %>"
  data-recipe-card-i18n-select-location-value="<%= t('recipes.margin_calculator.select_location') %>"
  class="bg-white rounded-lg shadow p-6 hover:bg-gray-50 transition-colors duration-200"
>
  <!-- Header -->
  <div class="flex justify-between items-start">
    <div>
      <h2 class="text-xl font-semibold"><%= recipe.name %></h2>
      <p class="text-sm text-gray-500 mt-1"><%= t("recipes.index.recipe_id", id: recipe.uid) %></p>
      <p class="text-sm text-gray-500 mt-1"><%= t("recipes.index.price_set", price: number_to_currency(recipe.price)) %></p>
    </div>
    <div class="flex flex-col gap-2 text-right">
      <%= link_to t("recipes.index.edit"), edit_recipe_path(recipe), class: "text-blue-500 hover:text-blue-700" %>
      <button data-action="click->recipe-card#toggle" class="text-sm text-gray-500 hover:text-gray-700">
        <%= t("recipes.index.calculate_cost_profit") %>
      </button>
      <button data-action="click->recipe-card#toggleIngredientsCalculator"
              class="text-sm text-gray-500 hover:text-gray-700">
        <%= t("recipes.index.calculate_ingredients_necessary") %>
      </button>
    </div>
  </div>

  <!-- Ingredients View -->
  <div data-recipe-card-target="details" class="mt-4">
    <h3 class="font-bold text-gray-700 mb-2"><%= t("recipes.index.ingredients") %></h3>

    <!-- Ingredient Calculator Input -->
    <div data-recipe-card-target="ingredientCalculator" class="mb-4 hidden">
      <label for="recipeMultiplier" class="block text-sm font-medium text-gray-700">
        <%= t("recipes.index.how_many_to_make") %>
      </label>
      <input
        type="number"
        min="1"
        value="1"
        id="recipeMultiplier"
        class="mt-1 block w-full rounded border px-3 py-2"
        data-action="input->recipe-card#updateIngredientQuantities"
        data-recipe-card-target="multiplierInput"
      >
    </div>

    <!-- Ingredient List -->
    <ul class="space-y-3">
      <% recipe.recipe_items.includes(product: :inventory_items).each do |item| %>
        <% product = item.product %>
        <li class="recipe-item flex flex-col gap-1 text-sm"
            data-product-name="<%= product.name %>"
            data-quantity="<%= item.quantity %>"
            data-unit="<%= item.unit %>"
            data-translated-unit="<%= t("units.#{item.unit}", default: item.unit.humanize) %>">
          <span class="font-medium">
            <%= product.name %> – 
            <span data-recipe-card-target="ingredientQuantity"
                  data-base-quantity="<%= item.quantity %>">
              <%= item.quantity %>
            </span>
            <%= t("units.#{item.unit}", default: item.unit.humanize) %>
          </span>

          <% product.inventory_items.each do |inv| %>
            <div class="inventory-option hidden"
                data-inventory-unit="<%= inv.unit_type %>"
                data-translated-unit="<%= t("units.#{inv.unit_type}", default: inv.unit_type.humanize) %>"
                data-price-per-unit="<%= inv.price %>"
                data-location-id="<%= inv.location_id %>"
                data-location-name="<%= inv.location&.name || t('recipes.location.unknown') %>">
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>

    <div class="mt-4 text-sm text-gray-500">
      <%= t("recipes.index.updated_ago", time: time_ago_in_words(recipe.updated_at)) %>
    </div>
  </div>

  <!-- Margin Calculator Section -->
  <div data-recipe-card-target="analysis" class="mt-4 hidden">
    <h3 class="text-lg font-semibold mb-4"><%= t("recipes.margin_calculator.title") %></h3>

    <!-- Location Selector -->
    <div class="mb-6">
      <label class="block text-sm font-medium mb-1">
        <%= t("recipes.margin_calculator.available_locations") %>
      </label>
      <select
        class="w-full border px-3 py-2 rounded"
        data-action="change->recipe-card#recalculate"
        data-recipe-card-target="locationSelect"
      >
        <option value=""><%= t("recipes.margin_calculator.select_location") %></option>
        <!-- Options populated by JS -->
      </select>
    </div>

    <!-- Ingredients Cost Breakdown -->
    <div class="space-y-4 mb-6" data-recipe-card-target="ingredientsList">
      <!-- Populated by JS -->
    </div>

    <!-- Selling Price + Totals -->
    <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
      <div>
        <label class="block text-sm font-medium mb-1">
          <%= t("recipes.margin_calculator.selling_price") %>
        </label>
        <input
          type="number" step="0.01"
          value="<%= recipe.price %>"
          class="w-full border px-3 py-2 rounded"
          data-action="input->recipe-card#recalculate"
          data-recipe-card-target="priceInput"
        >
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-white p-3 rounded border">
          <p class="text-sm font-medium text-gray-600"><%= t("recipes.margin_calculator.cost_to_make") %></p>
          <p class="text-lg font-bold">$<span data-recipe-card-target="totalCost">0.00</span></p>
        </div>
        <div class="bg-white p-3 rounded border">
          <p class="text-sm font-medium text-gray-600"><%= t("recipes.margin_calculator.profit") %></p>
          <p class="text-lg font-bold">$<span data-recipe-card-target="profit">0.00</span></p>
        </div>
        <div class="bg-white p-3 rounded border col-span-2">
          <p class="text-sm font-medium text-gray-600"><%= t("recipes.margin_calculator.margin") %></p>
          <p class="text-lg font-bold"><span data-recipe-card-target="marginPct">0.00</span>%</p>
        </div>
      </div>
    </div>

    <button data-action="click->recipe-card#toggle"
            class="mt-4 text-sm text-gray-500 hover:text-gray-700 w-full py-2 border border-gray-200 rounded-md">
      ← <%= t("recipes.margin_calculator.back_to_ingredients") %>
    </button>
  </div>
</div>
