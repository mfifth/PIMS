<%= form_with model: @order, local: false, data: { controller: "order-item-search" }, class: "bg-gray-50 p-8 rounded-lg shadow-md" do |f| %>
  <div class="mb-6">
    <%= f.label :location_id, "Location", class: "block text-sm font-semibold text-gray-700 mb-2" %>
    <%= f.collection_select :location_id, @locations, :id, :name, {},
      class: "w-full rounded-md border border-gray-300 bg-white px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",
      data: { order_item_search_target: "location" } %>
  </div>

  <div class="mb-6">
    <%= label_tag :inventory_search, "Search Inventory", class: "block text-sm font-semibold text-gray-700 mb-2" %>
    <%= text_field_tag :inventory_search, nil, placeholder: "Start typing to search inventory...", autocomplete: "off",
      class: "w-full rounded-md border border-gray-300 bg-white px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",
      data: { action: "input->order-item-search#search", order_item_search_target: "input" } %>
    <ul data-order-item-search-target="results" class="bg-white border border-gray-200 rounded mt-1 max-h-52 overflow-y-auto shadow-lg z-10"></ul>
  </div>

  <div data-order-item-search-target="itemsList" class="space-y-4 mb-8">
    <% @order.order_items.each_with_index do |order_item, index| %>
      <% item = order_item.item %>
      <% key = "#{order_item.item_type}-#{order_item.item_id}" %>
      <% base_unit = item.try(:unit_type) %>
      <% conversion_rates = item.try(:conversion_rates) || {} %>
      <% price = order_item.price %>

      <div class="grid grid-cols-12 gap-2 items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow duration-200"
           data-key="<%= key %>"
           data-price="<%= price %>"
           data-base-unit="<%= base_unit %>"
           data-conversion-rates="<%= conversion_rates.to_json %>">

        <div class="col-span-5">
          <div class="text-lg font-semibold text-gray-900"><%= item.try(:name) || item.product.name %></div>
          <div class="text-sm text-gray-500">$<%= '%.2f' % price %></div>
        </div>

        <div class="col-span-2">
          <% if order_item.item_type == "InventoryItem" %>
            <% compatible_units = UnitConversion.compatible_unit_options(item.unit_type || 'units') %>
            <select name="order[order_items_attributes][<%= index %>][unit]" 
                    class="unit-select w-full rounded-md border border-gray-300 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    data-base-unit="<%= item.unit_type || '' %>"
                    data-conversion-rates='<%= item.conversion_rates.to_json %>'
                    data-action="change->order-item-search#updateTotal">
              <% compatible_units.each do |opt| %>
                <option value="<%= opt[:value] %>" <%= "selected" if opt[:value] == order_item.unit %>>
                  <%= opt[:label] %>
                </option>
              <% end %>
            </select>
          <% else %>
            <div class="text-gray-700 font-medium"><%= order_item.unit %></div>
          <% end %>
        </div>

        <div class="col-span-2">
          <input type="number"
                 name="order[order_items_attributes][<%= index %>][quantity]"
                 value="<%= order_item.quantity %>"
                 min="0"
                 class="quantity-input w-full rounded-md border border-gray-300 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                 data-action="input->order-item-search#updateTotal"
                 aria-label="Quantity">
        </div>

        <div class="col-span-2 flex justify-end space-x-3">
          <button type="button"
                  class="text-red-600 hover:text-red-800 focus:outline-none"
                  data-action="click->order-item-search#removeItem"
                  data-key="<%= key %>"
                  aria-label="Remove item">&times;</button>

          <input type="hidden" name="order[order_items_attributes][<%= index %>][item_id]" value="<%= order_item.item_id %>">
          <input type="hidden" name="order[order_items_attributes][<%= index %>][item_type]" value="<%= order_item.item_type %>">
          <input type="hidden" name="order[order_items_attributes][<%= index %>][price]" value="<%= price %>">
          <input type="hidden" name="order[order_items_attributes][<%= index %>][location_id]" value="<%= order_item.location_id %>">
        </div>
      </div>
    <% end %>
  </div>

  <div data-order-item-search-target="hiddenInputs"></div>

  <div data-order-item-search-target="total" class="text-right font-extrabold text-2xl text-green-700 mb-6 tracking-wide">
    Total: $0.00
  </div>

  <div class="flex justify-end">
    <%= f.submit "Save Order", class: "bg-green hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold px-6 py-3 rounded-md shadow-md transition-colors duration-200" %>
  </div>
<% end %>
